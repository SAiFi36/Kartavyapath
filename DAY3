
# Day 03 — Put the To-Do app on HTTPS (public)

**Goal:** Serve the Flask app at **[https://todo.sunbeam.social](https://todo.sunbeam.social)** with a trusted TLS cert, and make the app “HTTPS-aware”.

---

## 0) Prereqs (one-time)

* **Web server public IP:** `139.59.38.237`
* **Domain:** `sunbeam.social` (at Name.com)
* **App:** running behind Gunicorn on `127.0.0.1:8000`
* **Firewall:** inbound **80/443** open to the web server
  *(Linux hostname can be anything, e.g. `web` — it doesn’t matter.)*

---

## 1) DNS → point the name to the server

At **Name.com → sunbeam.social → DNS** add A records:

| Host   | Type | Value           | TTL |
| ------ | ---- | --------------- | --- |
| `todo` | A    | `139.59.38.237` | 300 |

Verify:

```bash
dig +short todo.sunbeam.social A
# expected: 139.59.38.237
```

---

## 2) Nginx: set the server\_name (HTTP)

Edit your existing site (`/etc/nginx/sites-available/todo`) so the server\_name is the new host:

```bash
sudo sed -i 's/server_name .*/server_name todo.sunbeam.social;/' /etc/nginx/sites-available/todo
sudo rm -f /etc/nginx/sites-enabled/default
sudo nginx -t && sudo systemctl reload nginx
```

---

## 3) Issue & install a real TLS certificate (Let’s Encrypt)

```bash
sudo apt -y update
sudo apt -y install certbot python3-certbot-nginx
sudo certbot --nginx -d todo.sunbeam.social --redirect -m you@example.com --agree-tos --no-eff-email
sudo certbot renew --dry-run
```

* Adds an HTTPS vhost, installs the cert, and forces **HTTP → HTTPS** automatically.

---

## 4) Make Flask “HTTPS-aware” (recommended)

In `/var/www/todo/app.py`, **right after** `app = Flask(__name__)`:

```python
from werkzeug.middleware.proxy_fix import ProxyFix
app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_host=1, x_proto=1)

app.config.update(
    SESSION_COOKIE_SECURE=True,
    SESSION_COOKIE_SAMESITE='Lax',
    PREFERRED_URL_SCHEME='https'
)
```

Restart:

```bash
sudo systemctl restart todo
sudo journalctl -u todo -e --no-pager
```

---

## 5) (Nice to have) HSTS header

Add to the **HTTPS** server block in `/etc/nginx/sites-available/todo`:

```nginx
add_header Strict-Transport-Security "max-age=86400" always;  # start with 1 day
```

Later, bump to a year:

```nginx
add_header Strict-Transport-Security "max-age=31536000" always;
```

Reload Nginx:

```bash
sudo nginx -t && sudo systemctl reload nginx
```

---

## 6) Quick verification

```bash
curl -I http://todo.sunbeam.social      # 301 -> https
curl -I https://todo.sunbeam.social     # 200/302 with valid cert
curl -I https://todo.sunbeam.social | grep -i strict-transport-security  # shows HSTS if added
```

Open in a browser: **[https://todo.sunbeam.social](https://todo.sunbeam.social)** ✅

---

## 7) (Optional) Root & www redirect to the app

**DNS:** add `A` for `@` and `www` → `139.59.38.237`
**Cert:**

```bash
sudo certbot --nginx -d sunbeam.social -d www.sunbeam.social --redirect -m you@example.com --agree-tos --no-eff-email
```

**Nginx redirect site:** `/etc/nginx/sites-available/root-redirect`

```nginx
server {
    listen 80; listen [::]:80;
    server_name sunbeam.social www.sunbeam.social;
    return 301 https://todo.sunbeam.social$request_uri;
}
server {
    listen 443 ssl http2; listen [::]:443 ssl http2;
    server_name sunbeam.social www.sunbeam.social;
    ssl_certificate     /etc/letsencrypt/live/sunbeam.social/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/sunbeam.social/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    return 301 https://todo.sunbeam.social$request_uri;
}
```

Enable and reload:

```bash
sudo ln -sf /etc/nginx/sites-available/root-redirect /etc/nginx/sites-enabled/root-redirect
sudo nginx -t && sudo systemctl reload nginx
```

---

## 8) Renewal & maintenance

* Certbot auto-renews via system timer. Check anytime:

  ```bash
  systemctl list-timers | grep certbot
  sudo certbot renew --dry-run
  ```
* Logs if anything misbehaves:

  ```bash
  sudo journalctl -u todo -e --no-pager
  sudo tail -n 100 /var/log/nginx/error.log
  ```

---

### TL;DR

1. DNS `todo.sunbeam.social → 139.59.38.237`
2. Nginx `server_name todo.sunbeam.social`
3. `certbot --nginx -d todo.sunbeam.social --redirect`
4. Add `ProxyFix` + secure cookies in Flask, restart
5. (Optional) HSTS header; (Optional) root/www redirect

That’s the whole Day-03 in tidy steps.
